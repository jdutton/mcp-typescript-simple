# GitHub Workflow Generation Architecture

**Status**: Implemented (using vibe-validate)
**Last Updated**: 2025-10-18

## Overview

Validation pipeline auto-generates `.github/workflows/validate.yml` from `vibe-validate.config.mjs` to ensure perfect sync between local and CI validation.

**Migration**: Previously used custom tooling (`tools/generate-validate-workflow.ts`), now uses [vibe-validate](https://github.com/jdutton-vercel/vibe-validate) package.

## Single Source of Truth

```javascript
// vibe-validate.config.mjs - defines ALL validation steps
import { defineConfig, preset } from '@vibe-validate/config';

export default defineConfig({
  preset: preset('typescript-nodejs'),
  validation: {
    phases: [
      {
        name: 'Phase 1: Pre-Qualification + Build',
        parallel: true,
        steps: [
          { name: 'TypeScript type checking', command: 'npm run typecheck' },
          { name: 'ESLint code checking', command: 'npm run lint' },
          { name: 'OpenAPI validation', command: 'npm run test:openapi' },
          { name: 'Build', command: 'npm run build' },
        ],
      },
      {
        name: 'Phase 2: Testing',
        parallel: true,
        steps: [
          { name: 'Unit tests', command: 'npm run test:unit' },
          { name: 'Integration tests', command: 'npm run test:integration' },
          { name: 'STDIO system tests', command: 'npm run test:system:stdio' },
          { name: 'HTTP system tests', command: 'npm run test:system:ci' },
          { name: 'Headless browser tests', command: 'npm run test:system:headless' },
        ],
      },
    ],
  },
});
```

## Workflow Generation

```bash
# Generate validate.yml from config
npm run validate:generate-workflow
# or directly: npx vibe-validate generate-workflow

# Check if workflow needs regeneration
npm run validate:check-workflow-sync
# or directly: npx vibe-validate generate-workflow --check
```

Generated file: `.github/workflows/validate.yml`
- Header comment: "AUTO-GENERATED by vibe-validate - DO NOT EDIT"
- One GitHub Actions job per validation step
- Phase dependencies via `needs:` clause
- Parallel execution within each phase
- Auto-detection of pnpm/npm
- Matrix strategy support (optional)

## Sync Enforcement

Workflow sync is checked automatically by vibe-validate:
```bash
# Check if workflow is in sync
npx vibe-validate generate-workflow --check
# Exit code: 0 (in sync), 1 (out of sync), 2 (error)
```

## Local vs CI Execution

**Local** (`npm run validate`):
- Phase 1: 4 steps parallel (~60s)
- Phase 2: 5 steps parallel (~300s)
- Total: ~6 minutes
- Single runner, shared resources

**CI** (`.github/workflows/validate.yml`):
- Phase 1: 4 jobs parallel (dedicated runners)
- Phase 2: 5 jobs parallel (dedicated runners)
- Total: ~6 minutes
- Isolated runners, full resources each

## Separation of Concerns

**Validation owns**: `.github/workflows/validate.yml` (auto-generated)

**Manual workflows**:
- `.github/workflows/docker.yml` - Docker build validation
- `.github/workflows/deploy.yml` - Production deployment
- Other workflows as needed

Validation tooling does NOT generate or manage non-validation workflows.

## Docker Handling

**CI**: Separate `.github/workflows/docker.yml` validates Docker builds on PRs

**Local**: `npm run docker:dev` builds and runs Docker container

Docker build NOT included in `npm run validate` (too slow for pre-commit).

## Benefits

- ✅ Perfect sync (CI uses exact same steps as local)
- ✅ Single source of truth (validation-config.ts)
- ✅ Fail-fast (validation fails if workflow outdated)
- ✅ Clear boundaries (validate owns validate.yml only)
- ✅ Parallel execution (both local and CI)
- ✅ Git-tracked (validate.yml committed, reviewable)

## Design Principles

This architecture follows key principles that make validation reliable and maintainable:

1. **Single Source of Truth**: validation-config.ts defines all steps
2. **Auto-Generation**: CI workflow generated from config, not manually maintained
3. **Sync Enforcement**: Validation fails if workflow outdated (fail-fast)
4. **Parallel Execution**: Phase-based concurrency for speed
5. **Separation of Concerns**: Validation separate from deployment/Docker workflows
