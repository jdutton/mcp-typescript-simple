# vibe-validate configuration for mcp-typescript-simple
# See: https://github.com/jdutton/vibe-validate/blob/main/docs/configuration-reference.md

$schema: https://raw.githubusercontent.com/jdutton/vibe-validate/main/packages/config/vibe-validate.schema.json

developerFeedback: true

# Locking configuration - prevents concurrent validation runs from conflicting
# Using project-level locking since ports (3001, 64123, etc.) are shared across
# all directories running the same validation script
locking:
  enabled: true
  concurrencyScope: project
  projectId: mcp-typescript-simple

# Git settings
git:
  mainBranch: main

# Pre-commit hooks configuration
hooks:
  preCommit:
    enabled: true
    secretScanning:
      enabled: true
      scanCommand: "gitleaks protect --staged --verbose"

# Validation configuration
# Optimized for maximum parallelization: fast-fail static checks first, then all tests in parallel
validation:
  phases:
    # Phase 1: Fast-fail static checks (sequential in single runner - too fast for parallel overhead)
    - name: 'Static Analysis'
      parallel: false  # Sequential - saves runner overhead (total ~5s)
      steps:
        - name: TypeScript Type Check
          command: npm run typecheck
        - name: ESLint
          command: npm run lint
        - name: OpenAPI Validation
          command: npm run test:openapi

    # Phase 2: Build (depends on typecheck passing)
    - name: 'Build'
      parallel: false  # Single step
      steps:
        - name: Build Packages
          command: npm run build

    # Phase 3: All tests in parallel (optimized for runner efficiency)
    # Port conflicts handled by self-healing port management system
    - name: 'All Tests'
      parallel: true  # Run tests in parallel for maximum speed
      steps:
        # Combine short tests into one step to reduce runner overhead
        - name: Security & Contract Tests
          command: npm run security:check && npm run test:contract:local
        # Combine unit + integration tests (reduce runner overhead)
        - name: Unit & Integration Tests
          command: npm run test:unit && npm run test:integration
        # Keep longer tests separate for parallel execution
        - name: System Tests (STDIO)
          command: npm run test:system:stdio
        - name: System Tests (HTTP)
          command: npm run test:system:ci
        - name: Headless Browser Tests
          command: npx playwright install --with-deps chromium && npm run test:system:headless
